#! /usr/bin/env python3

from smartcard.System import readers
# define the APDUs used in this script
COMMAND = [0xFF, 0xCA, 0x00, 0x00, 0x00]
LOAD_KEY = [0xFF, 0x82, 0x20, 0x01, 0x06, 0xFF , 0xFF, 0xFF, 0xFF, 0xFF, 0xFF]
AUTHENTICATE =[0xFF, 0x86, 0x00, 0x00, 0x05, 0x01, 0x00, 0x01, 0x60, 0x01]

def write(reader):
    print ('write')
    try:
        DATA = [0x53, 0x61, 0x79, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x4d, 0x79, 0x46, 0x72, 0x69, 0x65, 0x6e, 0x64 ]
        WRITE = [0xFF, 0xF4, 0x00, 0x01]
        connection = reader.createConnection()
        connection.connect()
        data, sw1, sw2 = connection.transmit(WRITE)
        print('data', data, 'sw1', sw1, 'sw2', sw2)
    except Exception:
        print ("No card detected. ")

def read(reader):
    print ("READ")
    try:
        connection = reader.createConnection()
        connection.connect()
        data, sw1, sw2 = connection.transmit(COMMAND)
        print ("UID[]:", data)
        print ("UID h:", " ".join(['{:02X}'.format(h) for h in data]))
        print ("Command: %02X %02X" % (sw1, sw2))
        print('data', data, 'sw1', sw1, 'sw2', sw2)
    except Exception:
        print ("No card detected. ")

def auth(reader):
    print ("AUTHENTICATION")
    try:
        # 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        # 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
        # 0xa0, 0xb0, 0xc0, 0xd0, 0xe0, 0xf0
        # 0xa1, 0xb1, 0xc1, 0xd1, 0xe1, 0xf1
        # 0xa0, 0xa1, 0xa2, 0xa3, 0xa4, 0xa5 
        # 0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5
        # 0x4d, 0x3a, 0x99, 0xc3, 0x51, 0xdd 
        # 0x1a, 0x98, 0x2c, 0x7e, 0x45, 0x9a
        # 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        # 0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff
        # 0xd3, 0xf7, 0xd3, 0xf7, 0xd3, 0xf7
        # 0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff
        # 0x71, 0x4c, 0x5c, 0x88, 0x6e, 0x97
        # 0x58, 0x7e, 0xe5, 0xf9, 0x35, 0x0f
        # 0xa0, 0x47, 0x8c, 0xc3, 0x90, 0x91
        # 0x53, 0x3c, 0xb6, 0xc7, 0x23, 0xf6
        # 0x8f, 0xd0, 0xa4, 0xf2, 0x56, 0xe9
        
        LOAD_KEY = [0xFF, 0x82, 0x20, 0x00, 0x06, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF]
        AUTH = [0xFF, 0x86, 0x00, 0x00, 0x05, 0x01, 0x00, 0x1F, 0x60, 0x00]
        READ = [0xFF, 0xB0, 0x00, 0x02, 0x10]
        READ_SPECIFIC =[0xFF, 0xF4, 0x00, 0x01, 0x02, 0x61, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF]
        connection = reader.createConnection()
        connection.connect()
        data, sw1, sw2 = connection.transmit(LOAD_KEY)
        print('data', data, 'sw1', hex(sw1), 'sw2', hex(sw2))
        data, sw1, sw2 = connection.transmit(AUTH)
        print('data', data, 'sw1', hex(sw1), 'sw2', hex(sw2))
        data, sw1, sw2 = connection.transmit(READ)
        print('data', data, 'sw1', hex(sw1), 'sw2', hex(sw2))
    except Exception:
        print ("No card detected. ")

def loadK():
    print ("LOAD KEY")

# get all the available readers
r = readers()
print ("Available readers:", r)

reader = r[0]
print ("Using:", reader)
auth(reader)
#read(reader)
#write(reader)
